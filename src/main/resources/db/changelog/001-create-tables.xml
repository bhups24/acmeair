<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="001-create-enhanced-flights-table" author="acme-air">
        <createTable tableName="flights">
            <column name="id" type="VARCHAR(10)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="flight_number" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="origin" type="VARCHAR(3)">
                <constraints nullable="false"/>
            </column>
            <column name="destination" type="VARCHAR(3)">
                <constraints nullable="false"/>
            </column>
            <column name="departure_time" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="arrival_time" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="aircraft" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>

            <!-- Pricing by seat class -->
            <column name="economy_price" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="premium_economy_price" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="business_price" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="first_class_price" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>

            <!-- Available seats by class -->
            <column name="economy_available" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="premium_economy_available" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="business_available" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="first_class_available" type="INT">
                <constraints nullable="false"/>
            </column>

            <!-- Total seats by class -->
            <column name="economy_total" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="premium_economy_total" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="business_total" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="first_class_total" type="INT">
                <constraints nullable="false"/>
            </column>

            <!-- Flight characteristics -->
            <column name="is_direct" type="BOOLEAN" defaultValue="true">
                <constraints nullable="false"/>
            </column>
            <column name="stops" type="INT" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex tableName="flights" indexName="idx_origin_destination">
            <column name="origin"/>
            <column name="destination"/>
        </createIndex>

        <createIndex tableName="flights" indexName="idx_departure_time">
            <column name="departure_time"/>
        </createIndex>

        <createIndex tableName="flights" indexName="idx_economy_price">
            <column name="economy_price"/>
        </createIndex>

        <createIndex tableName="flights" indexName="idx_is_direct">
            <column name="is_direct"/>
        </createIndex>
    </changeSet>

    <changeSet id="002-create-passengers-table" author="acme-air">
        <createTable tableName="passengers">
            <column name="id" type="VARCHAR(10)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="first_name" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="last_name" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="email" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="phone_number" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="passport_number" type="VARCHAR(12)">
                <constraints nullable="false"/>
            </column>
            <column name="date_of_birth" type="DATE">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex tableName="passengers" indexName="idx_email">
            <column name="email"/>
        </createIndex>

        <createIndex tableName="passengers" indexName="idx_passport_number">
            <column name="passport_number"/>
        </createIndex>
    </changeSet>

    <changeSet id="003-create-enhanced-bookings-table" author="acme-air">
        <createTable tableName="bookings">
            <column name="id" type="VARCHAR(12)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="flight_id" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="return_flight_id" type="VARCHAR(10)">
                <constraints nullable="true"/>
            </column>
            <column name="passenger_id" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="booking_time" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="seat_class" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="flight_type" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="seat_number" type="VARCHAR(5)">
                <constraints nullable="true"/>
            </column>
            <column name="return_seat_number" type="VARCHAR(5)">
                <constraints nullable="true"/>
            </column>
            <column name="total_price" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
                baseTableName="bookings"
                baseColumnNames="flight_id"
                referencedTableName="flights"
                referencedColumnNames="id"
                constraintName="fk_booking_flight"/>

        <addForeignKeyConstraint
                baseTableName="bookings"
                baseColumnNames="return_flight_id"
                referencedTableName="flights"
                referencedColumnNames="id"
                constraintName="fk_booking_return_flight"/>

        <addForeignKeyConstraint
                baseTableName="bookings"
                baseColumnNames="passenger_id"
                referencedTableName="passengers"
                referencedColumnNames="id"
                constraintName="fk_booking_passenger"/>

        <createIndex tableName="bookings" indexName="idx_flight_id">
            <column name="flight_id"/>
        </createIndex>

        <createIndex tableName="bookings" indexName="idx_booking_time">
            <column name="booking_time"/>
        </createIndex>

        <createIndex tableName="bookings" indexName="idx_seat_class">
            <column name="seat_class"/>
        </createIndex>

        <createIndex tableName="bookings" indexName="idx_flight_type">
            <column name="flight_type"/>
        </createIndex>
    </changeSet>

    <changeSet id="004-create-api-tokens-table" author="acme-air">
        <createTable tableName="api_tokens">
            <column name="id" type="VARCHAR(12)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="token_value" type="VARCHAR(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="description" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_time" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="is_active" type="BOOLEAN" defaultValue="true">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex tableName="api_tokens" indexName="idx_token_value">
            <column name="token_value"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>